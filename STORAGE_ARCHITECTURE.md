# Storage Architecture - Phase 1.3

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —Å—Ö–æ–≤–∏—â–µ

–£—Å—ñ –¥–∞–Ω—ñ –¥–æ–¥–∞—Ç–∫—É –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞ **—Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ**, –∞ –ù–ï –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –∫–æ–∂–Ω–æ–º—É –ü–ö. –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –¥–∞–Ω–∏—Ö –º—ñ–∂ —É—Å—ñ–º–∞ –∫–æ–º–ø'—é—Ç–µ—Ä–∞–º–∏ –≤ –º–µ—Ä–µ–∂—ñ.

## üìç –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –Ω–∞ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ

### –ë–∞–∑–æ–≤–∏–π —à–ª—è—Ö
```
\\SERVER\SHARE\2Packing-tool/
```

–ù–∞–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –≤ `config.ini`:
```ini
[Network]
FileServerPath = \\192.168.88.101\Z_GreenDelivery\WAREHOUSE\2Packing-tool
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥—ñ–≤

```
\\SERVER\SHARE\2Packing-tool/
‚îÇ
‚îú‚îÄ‚îÄ CLIENTS/                          # –ü—Ä–æ—Ñ—ñ–ª—ñ –∫–ª—ñ—î–Ω—Ç—ñ–≤
‚îÇ   ‚îî‚îÄ‚îÄ CLIENT_{ID}/
‚îÇ       ‚îú‚îÄ‚îÄ config.json              # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞
‚îÇ       ‚îú‚îÄ‚îÄ sku_mapping.json         # SKU –º–∞–ø—ñ–Ω–≥–∏ –∑ file locking
‚îÇ       ‚îî‚îÄ‚îÄ backups/                 # –ë–µ–∫–∞–ø–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π
‚îÇ
‚îú‚îÄ‚îÄ SESSIONS/                         # –Ü—Å—Ç–æ—Ä—ñ—è —Å–µ—Å—ñ–π
‚îÇ   ‚îî‚îÄ‚îÄ CLIENT_{ID}/
‚îÇ       ‚îî‚îÄ‚îÄ {TIMESTAMP}/             # –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ —Å–µ—Å—ñ—è
‚îÇ           ‚îú‚îÄ‚îÄ .session.lock        # –§–∞–π–ª –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
‚îÇ           ‚îú‚îÄ‚îÄ session_info.json    # –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–µ—Å—ñ—é
‚îÇ           ‚îú‚îÄ‚îÄ packing_state.json   # –ü—Ä–æ–≥—Ä–µ—Å –ø–∞–∫—É–≤–∞–Ω–Ω—è
‚îÇ           ‚îî‚îÄ‚îÄ barcodes/            # –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –±–∞—Ä–∫–æ–¥–∏
‚îÇ
‚îî‚îÄ‚îÄ STATS/                            # ‚≠ê –ù–û–í–ï –≤ Phase 1.3
    ‚îî‚îÄ‚îÄ stats.json                   # –ì–ª–æ–±–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞
```

## üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ –ü–ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è:

1. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** (`STATS/stats.json`):
   - ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ
   - ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞ –∑ —É—Å—ñ—Ö –ü–ö
   - ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î file locking –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É
   - ‚úÖ –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∫–æ–∂–Ω–æ—ó —Å–µ—Å—ñ—ó

2. **–Ü—Å—Ç–æ—Ä—ñ—è —Å–µ—Å—ñ–π** (`SESSIONS/`):
   - ‚úÖ –í—Å—ñ —Å–µ—Å—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
   - ‚úÖ –ö–æ–∂–µ–Ω –ü–ö –±–∞—á–∏—Ç—å —Å–µ—Å—ñ—ó —ñ–Ω—à–∏—Ö –ü–ö
   - ‚úÖ SessionHistoryManager —á–∏—Ç–∞—î –∑ –º–µ—Ä–µ–∂—ñ

3. **–ü—Ä–æ—Ñ—ñ–ª—ñ –∫–ª—ñ—î–Ω—Ç—ñ–≤** (`CLIENTS/`):
   - ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
   - ‚úÖ SKU –º–∞–ø—ñ–Ω–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å—ñ–º
   - ‚úÖ File locking –¥–ª—è concurrent access

## üîí File Locking (–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤)

–î–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ–º—É –¥–æ—Å—Ç—É–ø—ñ –∑ –∫—ñ–ª—å–∫–æ—Ö –ü–ö:

### –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –º–µ—Ö–∞–Ω—ñ–∑–º–∏:

1. **Session Locks** (`.session.lock`):
   - –ì–∞—Ä–∞–Ω—Ç—É—î, —â–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –ü–ö –ø—Ä–∞—Ü—é—î –Ω–∞–¥ —Å–µ—Å—ñ—î—é
   - Heartbeat –∫–æ–∂–Ω—ñ 60 —Å–µ–∫—É–Ω–¥
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è stale locks

2. **SKU Mapping Locks**:
   - Windows `msvcrt.locking()` –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É
   - –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –Ω–∞ —á–∞—Å —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É

3. **Statistics Locks** (–ù–û–í–ï –≤ Phase 1.3):
   - Windows `msvcrt.locking()` –¥–ª—è stats.json
   - Exclusive lock –ø—Ä–∏ –∑–∞–ø–∏—Å—ñ
   - Shared lock –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ

## üìä –©–æ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –¥–µ?

### –ù–∞ —Ñ–∞–π–ª–æ–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ (–¶–ï–ù–¢–†–ê–õ–Ü–ó–û–í–ê–ù–û):
‚úÖ –ü—Ä–æ—Ñ—ñ–ª—ñ –∫–ª—ñ—î–Ω—Ç—ñ–≤ (`CLIENTS/`)
‚úÖ –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—ñ—Ö —Å–µ—Å—ñ–π (`SESSIONS/`)
‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (`STATS/stats.json`)
‚úÖ SKU –º–∞–ø—ñ–Ω–≥–∏
‚úÖ –ë–∞—Ä–∫–æ–¥–∏
‚úÖ –ó–≤—ñ—Ç–∏ –ø—Ä–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ñ —Å–µ—Å—ñ—ó

### –õ–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –ü–ö (—Ç—ñ–ª—å–∫–∏ –∫–µ—à —ñ –ª–æ–≥–∏):
üìÅ `~/.packers_assistant/cache/` - —Ç–∏–º—á–∞—Å–æ–≤–∏–π –∫–µ—à (60 —Å–µ–∫—É–Ω–¥)
üìÅ `~/.packers_assistant/logs/` - –ª–æ–≥–∏ –¥–æ–¥–∞—Ç–∫—É
üìÅ `~/.packers_assistant/sounds/` - –∑–≤—É–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

‚ö†Ô∏è **–í–ê–ñ–õ–ò–í–û:** –ü—ñ—Å–ª—è Phase 1.3 stats.json –±—ñ–ª—å—à–µ –ù–ï –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ!

## üéØ –ü–µ—Ä–µ–≤–∞–≥–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞

1. **–Ñ–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ –ø—Ä–∞–≤–¥–∏**: –í—Å—ñ –ü–ö –±–∞—á–∞—Ç—å –æ–¥–Ω–∞–∫–æ–≤—ñ –¥–∞–Ω—ñ
2. **–†–µ–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞**: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å—ñ—Ö –ü–ö —Ä–∞–∑–æ–º
3. **–ö–æ–º–∞–Ω–¥–Ω–∞ —Ä–æ–±–æ—Ç–∞**: –ú–æ–∂–Ω–∞ –±–∞—á–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ —Å–µ—Å—ñ—ó –∫–æ–ª–µ–≥
4. **–Ü—Å—Ç–æ—Ä—ñ—è**: –ü–æ–≤–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è –≤—Å—ñ—Ö —Å–µ—Å—ñ–π –∑ —É—Å—ñ—Ö –ü–ö
5. **–ë–µ–∫–∞–ø–∏**: –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ –ª–µ–≥—à–µ –±–µ–∫–∞–ø–∏—Ç–∏

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### ProfileManager

–ú–µ—Ç–æ–¥–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —à–ª—è—Ö—ñ–≤:

```python
# –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä—ñ–Ω—å —Å–µ—Å—ñ–π
sessions_root = profile_manager.get_sessions_root()
# –ü–æ–≤–µ—Ä—Ç–∞—î: Path('\\\\SERVER\\...\\SESSIONS')

# –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä—ñ–Ω—å –∫–ª—ñ—î–Ω—Ç—ñ–≤
clients_root = profile_manager.get_clients_root()
# –ü–æ–≤–µ—Ä—Ç–∞—î: Path('\\\\SERVER\\...\\CLIENTS')

# –û—Ç—Ä–∏–º–∞—Ç–∏ —à–ª—è—Ö –¥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
stats_path = profile_manager.get_global_stats_path()
# –ü–æ–≤–µ—Ä—Ç–∞—î: Path('\\\\SERVER\\...\\STATS\\stats.json')
```

### StatisticsManager

–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ ProfileManager:

```python
# –ü–†–ê–í–ò–õ–¨–ù–û - —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —Å—Ö–æ–≤–∏—â–µ
stats_manager = StatisticsManager(profile_manager=profile_manager)

# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ª–æ–∫–∞–ª—å–Ω–µ —Å—Ö–æ–≤–∏—â–µ (deprecated)
stats_manager = StatisticsManager()  # –ü–æ–∫–∞–∑—É—î warning!
```

### SessionHistoryManager

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ñ–∞–π–ª–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä:

```python
history_manager = SessionHistoryManager(profile_manager)
sessions = history_manager.get_client_sessions("M")
# –ß–∏—Ç–∞—î –∑: \\\\SERVER\\...\\SESSIONS\\CLIENT_M\\
```

## üìù –ú—ñ–≥—Ä–∞—Ü—ñ—è

–Ø–∫—â–æ —É –≤–∞—Å –≤–∂–µ —î –ª–æ–∫–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ `~/.packers_assistant/stats.json`:

1. –î–æ–¥–∞—Ç–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç—å –Ω–æ–≤—É —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω—É –±–∞–∑—É
2. –°—Ç–∞—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ù–ï –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
3. –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å—É –≤—Ä—É—á–Ω—É: —Å–∫–æ–ø—ñ—é–π—Ç–µ stats.json –Ω–∞ —Å–µ—Ä–≤–µ—Ä —É `STATS/`

## üö® –í–∏–º–æ–≥–∏

1. **–ú–µ—Ä–µ–∂–µ–≤–∏–π –¥–æ—Å—Ç—É–ø**: –í—Å—ñ –ü–ö –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
2. **–ü—Ä–∞–≤–∞ –∑–∞–ø–∏—Å—É**: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å—É –≤ –∫–∞—Ç–∞–ª–æ–≥–∏
3. **Windows**: File locking –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –Ω–∞ Windows
4. **–ß–∞—Å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó**: –ü–ö –ø–æ–≤–∏–Ω–Ω—ñ –º–∞—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π —á–∞—Å

## üêõ –£—Å—É–Ω–µ–Ω–Ω—è –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### "Statistics using LOCAL storage" warning:
- –ü—Ä–∏—á–∏–Ω–∞: ProfileManager –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∏–π –¥–æ StatisticsManager
- –†—ñ—à–µ–Ω–Ω—è: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –≤ main.py

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –º—ñ–∂ –ü–ö:
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ `\\\\SERVER\\...\\STATS\\stats.json`
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å—É
- –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥–∏: `~/.packers_assistant/logs/`

### Session lock conflicts:
- Heartbeat –ø–æ–≤–∏–Ω–µ–Ω –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏—Å—è –∫–æ–∂–Ω—ñ 60 —Å–µ–∫—É–Ω–¥
- Stale locks –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è —á–µ—Ä–µ–∑ 120 —Å–µ–∫—É–Ω–¥
- –ú–æ–∂–Ω–∞ force-release —á–µ—Ä–µ–∑ Session Monitor

---

**–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** Phase 1.3 (2025-10-28)
**–í–µ—Ä—Å—ñ—è:** 1.3.0
